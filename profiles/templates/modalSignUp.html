{% load static %}
{% if not user.is_authenticated %}
<div id="auth-overlay" class="auth-overlay" aria-hidden="false">
  <div class="auth-modal">
    <button id="auth-close" class="auth-close" aria-label="Close">
      &times;
    </button>
    <img src="{% static 'img/logo_icon.svg' %}" class="mb-3 logo-spin-hover" width="80">
    <h3>Welcome to COLSP</h3>
    <p>Sign up or log in to personalize your experience.</p>
    <div
      style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem"
    >
      {%include 'signUp_signIn.html'%}
    </div>
  </div>
</div>
<script>
  (function () {
    // Call guest-login API when user closes the modal or clicks guest button
    function doGuestLogin() {
      fetch("/api/auth/guest-login/", {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json",
        },
        body: JSON.stringify({}),
      })
        .then((r) => r.json())
        .then((data) => {
          console.log("guest-login response", data);
          if (data && data.status === "success") {
            // redirect to root so templates render authenticated sidebar
            window.location.href = "/";
            return;
          }
          // fallback reload
          location.reload();
        })
        .catch((err) => {
          console.error("guest-login error", err);
          location.reload();
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
      var closeBtn = document.getElementById("auth-close");
      var guestBtn = document.getElementById("guest-btn");
      closeBtn && closeBtn.addEventListener("click", doGuestLogin);
      guestBtn && guestBtn.addEventListener("click", doGuestLogin);
    });
  })();
</script>
{% endif %}
